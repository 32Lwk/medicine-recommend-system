# 医薬品相談AIプログラム

このプログラムは、症状を入力すると適切な市販薬を提案し、薬の飲み合わせや注意点についてアドバイスを提供するAIシステムです。コマンドライン版とWebアプリケーション版の両方を提供しています。

## 🚀 最新アップデート（2024年12月）

### ✅ 修正完了項目
- **APIキー管理の改善**: `medicine_logic.py`からの統一されたAPIキー取得
- **OpenAI API呼び出しの修正**: メッセージ形式とNoneチェックの追加
- **エラーハンドリングの強化**: APIレスポンスの安全な処理
- **型エラーの修正**: メッセージパラメータの正しい形式対応
- **テスト機能の追加**: 包括的なテストスクリプトの実装

### 📊 テスト結果
- ✅ CSVファイル読み込み: 成功（124行のデータ）
- ✅ APIキー設定: 成功
- ✅ OpenAIクライアント: 成功
- ✅ 症状マッチング: 正常動作
- ✅ 薬の検索: 正常動作
- ✅ Webアプリケーション: 正常起動

## セットアップ

### 1. 必要なライブラリのインストール

```bash
pip install pandas openai python-dotenv flask
```

### 2. OpenAI APIキーの安全な設定

#### 方法1: 環境変数を使用（推奨）

**Windows PowerShellの場合：**
```powershell
# 一時的な設定（現在のセッションのみ）
$env:OPENAI_API_KEY="your-api-key-here"

# 永続的な設定（ユーザー環境変数）
[Environment]::SetEnvironmentVariable("OPENAI_API_KEY", "your-api-key-here", "User")
```

**Windows コマンドプロンプトの場合：**
```cmd
# 一時的な設定
set OPENAI_API_KEY=your-api-key-here

# 永続的な設定
setx OPENAI_API_KEY "your-api-key-here"
```

**Linux/Macの場合：**
```bash
# 一時的な設定
export OPENAI_API_KEY="your-api-key-here"

# 永続的な設定（~/.bashrcまたは~/.zshrcに追加）
echo 'export OPENAI_API_KEY="your-api-key-here"' >> ~/.bashrc
source ~/.bashrc
```

#### 方法2: .envファイルを使用（推奨）

1. 同じディレクトリに`.env`ファイルを作成：
```env
OPENAI_API_KEY=your-api-key-here
```

2. `.gitignore`ファイルに以下を追加（Gitを使用している場合）：
```
.env
*.env
```

#### 方法3: コード内で直接設定（非推奨）

セキュリティ上の理由から推奨されませんが、テスト目的で使用する場合：
```python
api_key = "your-api-key-here"
```

### 3. CSVファイルの確認

`症状-薬.csv`ファイルが同じディレクトリに配置されていることを確認してください。

## 使用方法

### コマンドライン版

1. プログラムを実行：
```bash
python 医薬品.py
```

2. 症状を入力（例：「喉が痛くて熱がある」）

3. 提案された市販薬と注意点を確認

4. 必要に応じて追加の質問を入力

5. 「終了」と入力してプログラムを終了

### Webアプリケーション版

#### メインアプリケーション
1. Flaskアプリケーションを実行：
```bash
python app.py
```

2. ブラウザで `http://localhost:5000` にアクセス

3. チャット形式で症状を入力

4. AIからの回答を確認

5. 必要に応じて追加の質問を入力

#### テストアプリケーション
1. テスト用アプリケーションを実行：
```bash
python test_app.py
```

2. ブラウザで `http://localhost:5002` にアクセス

3. APIモードとモックモードの切り替えが可能
4. 各機能の個別テストが実行可能

#### デバッグアプリケーション
1. デバッグ用アプリケーションを実行：
```bash
python debug_app.py
```

2. ブラウザで `http://localhost:5001` にアクセス

3. システム状態の確認とログ管理が可能

### テスト実行

基本的な機能テストを実行：
```bash
python test_simple.py
```

## 機能

- **症状診断**: 入力された症状から該当する部位と症状の組み合わせを推定
- **市販薬提案**: 症状に応じた適切な市販薬を3つまで提案
- **注意点生成**: 症状に基づいた注意点と医師受診のタイミングを説明
- **飲み合わせチェック**: 複数の薬の成分重複や併用禁忌をチェック
- **質問対応**: 医薬品や病気に関する追加質問に回答
- **Webインターフェース**: ブラウザベースのチャット形式UI
- **テスト機能**: APIモードとモックモードの切り替え
- **デバッグ機能**: システム状態の監視とログ管理

## セキュリティに関する重要な注意事項

### APIキーの安全な管理

1. **絶対にGitにコミットしない**
   - APIキーを含むファイルは`.gitignore`に追加
   - 公開リポジトリにAPIキーをアップロードしない

2. **環境変数の使用を推奨**
   - システム環境変数として設定
   - アプリケーション固有の設定として管理

3. **.envファイルの使用**
   - ローカル開発環境での使用
   - 本番環境では環境変数を使用

4. **定期的なキーのローテーション**
   - 定期的にAPIキーを更新
   - 不要になったキーは削除

5. **アクセス制限の設定**
   - APIキーに適切な権限を設定
   - 必要最小限の権限のみ付与

### 推奨されるセキュリティプラクティス

- 本番環境では環境変数を使用
- 開発環境では`.env`ファイルを使用
- APIキーをログに出力しない
- エラーメッセージにAPIキー情報を含めない
- 定期的にセキュリティ監査を実施

## 注意事項

- このプログラムは医療アドバイスではありません
- 最終的な判断は医師や薬剤師に相談してください
- 体調に変化があった場合は専門家にご相談ください
- APIキーは安全に管理し、公開しないでください

## ファイル構成

### メインプログラム
- `医薬品.py`: コマンドライン版メインプログラム
- `app.py`: Flask Webアプリケーション（メイン）
- `test_app.py`: Flask Webアプリケーション（テスト用）
- `debug_app.py`: Flask Webアプリケーション（デバッグ用）
- `medicine_logic.py`: 医薬品ロジックモジュール（Webアプリ用）
- `test_simple.py`: 基本機能テストスクリプト

### データファイル
- `症状-薬.csv`: 症状と医薬品の対応データ

### Webアプリケーション関連
- `templates/`: HTMLテンプレート
  - `index.html`: メインチャットインターフェース
  - `debug_index.html`: デバッグ用インターフェース
  - `test_index.html`: テスト用インターフェース
- `static/`: 静的ファイル（CSS、JavaScript等）

### 設定ファイル
- `.env`: APIキー設定ファイル（作成が必要）
- `README.md`: このファイル

## トラブルシューティング

### APIキーが認識されない場合

1. 環境変数が正しく設定されているか確認
2. `.env`ファイルが正しい場所にあるか確認
3. ファイルの文字エンコーディングがUTF-8か確認
4. プログラムを再起動して環境変数を再読み込み

### Webアプリケーションが起動しない場合

1. Flaskがインストールされているか確認
2. ポート5000、5001、5002が使用されていないか確認
3. ファイアウォールの設定を確認

### CSVファイルが読み込めない場合

1. ファイルが正しい場所にあるか確認
2. ファイルの文字エンコーディングを確認
3. ファイルの権限設定を確認

### エラーが発生した場合

1. `python test_simple.py`を実行して基本機能をテスト
2. ログを確認してエラーの詳細を把握
3. APIキーとCSVファイルの設定を再確認

## 開発者向け情報

### アプリケーションの同時起動

複数のアプリケーションを同時に起動する場合：

```bash
# ターミナル1: メインアプリケーション
python app.py

# ターミナル2: テストアプリケーション
python test_app.py

# ターミナル3: デバッグアプリケーション
python debug_app.py
```

### テストの実行

```bash
# 基本機能テスト
python test_simple.py

# Webアプリケーションテスト
# ブラウザで http://localhost:5002 にアクセス
```

### デバッグとログ管理

```bash
# デバッグアプリケーションの起動
python debug_app.py

# ブラウザで http://localhost:5001 にアクセス
# システム状態とログを確認
```

## ライセンス

このプロジェクトは教育・研究目的で作成されています。商用利用の際は適切なライセンスを確認してください。

## 貢献

バグ報告や機能改善の提案は歓迎します。プルリクエストを送信する前に、テストを実行して動作を確認してください。 